# TTS在线播放掉帧问题修复说明

## 问题描述
TTS在线播放时偶发掉帧问题,下载后的音频文件播放正常,说明问题出在实时传输环节。

## 问题根因分析

### 1. WebRTC音频队列容量不足
- **原问题**: 队列大小固定为100帧(仅2秒缓冲)
- **影响**: TTS生成速度快时,队列容易满,导致生产端阻塞或丢帧
- **位置**: `src/webrtc.py:48`

### 2. 音频帧时间同步过于严格
- **原问题**: 严格等待时间同步,不允许任何负延迟
- **影响**: 系统负载高时,轻微延迟会累积,最终导致跳帧
- **位置**: `src/webrtc.py:76-79`

### 3. 跨线程队列操作可能阻塞
- **原问题**: 使用阻塞式put操作,无超时控制
- **影响**: 队列满时生产线程会长时间阻塞
- **位置**: `src/basereal.py:328`

## 修复方案

### 1. 扩大音频队列容量 ✅
```python
# 修改前
self._queue = asyncio.Queue(maxsize=100)

# 修改后
maxsize = 500 if kind == 'audio' else 100  # 音频10秒缓冲,视频4秒缓冲
self._queue = asyncio.Queue(maxsize=maxsize)
```

**效果**: 提供更大的缓冲空间,减少队列满的概率

### 2. 优化时间同步策略 ✅
```python
# 允许小幅度负延迟(-100ms内正常)
if wait < -0.1:  # 延迟超过100ms才重新校准
    self.dropped_frames += 1
    self._start = time.time() - self.current_frame_count * AUDIO_PTIME
elif wait > 0:
    await asyncio.sleep(wait)
```

**效果**: 
- 容忍小幅延迟,避免过度校准
- 延迟过大时自动重新校准时间基准
- 防止延迟累积

### 3. 非阻塞队列操作 ✅
```python
try:
    future = asyncio.run_coroutine_threadsafe(
        audio_track._queue.put((new_frame, eventpoint)), 
        loop
    )
    future.result(timeout=0.05)  # 50ms超时
except Exception as e:
    # 记录但不阻塞,继续处理后续帧
    self.audio_monitor.record_queue_full()
```

**效果**: 
- 避免生产端长时间阻塞
- 队列满时快速失败,不影响整体流程

### 4. 添加音频监控工具 ✅
新增 `src/audio_monitor.py` 监控模块,实时追踪:
- 音频帧生产/消费速率
- 队列积压情况
- 队列满次数
- 延迟警告次数

**使用方法**:
```bash
# 启用监控(默认)
python main.py

# 禁用监控
AUDIO_MONITOR=0 python main.py
```

监控报告示例:
```
╔══════════════════════════════════════════════════════════╗
║           音频队列监控报告 (过去 10.0秒)            
╠══════════════════════════════════════════════════════════╣
║ 生产帧数:      500 (  50.0 帧/秒)           
║ 消费帧数:      500 (  50.0 帧/秒)           
║ 队列积压:        0 帧 (0.00秒)        
║ 队列满次数:      0                                   
║ 延迟警告:        0                                       
╚══════════════════════════════════════════════════════════╝
```

## 修改的文件

1. **src/webrtc.py**
   - 扩大音频队列容量(100→500帧)
   - 优化音频时间同步逻辑
   - 添加掉帧统计和监控集成

2. **src/basereal.py**
   - 非阻塞音频队列操作
   - 添加超时控制
   - 集成音频监控

3. **src/ttsreal.py**
   - 添加帧数统计日志
   - 优化流处理日志

4. **src/audio_monitor.py** (新增)
   - 音频队列监控工具

## 测试建议

### 1. 功能测试
```bash
# 启动服务
python main.py --tts doubao3

# 访问测试页面
http://127.0.0.1:8010/index.html

# 测试场景:
# 1. 短文本(10字以内)
# 2. 中等文本(50-100字)
# 3. 长文本(200字以上)
# 4. 连续多次TTS请求
```

### 2. 监控日志观察
关注以下指标:
- **队列积压**: 应保持在较低水平(<100帧)
- **队列满次数**: 应为0或极少
- **延迟警告**: 应为0或极少
- **生产/消费速率**: 应基本一致(~50帧/秒)

### 3. 音质检查
- 播放是否流畅,无卡顿
- 音频是否有断续或跳跃
- 与下载后播放对比,确认一致性

## 性能影响

- **内存**: 音频队列从100帧增加到500帧,增加约256KB内存(每帧640字节)
- **CPU**: 非阻塞操作减少线程等待,CPU利用率略有提升
- **延迟**: 首帧延迟无变化,整体流畅度提升

## 回滚方案

如果出现问题,可以通过以下方式回滚:

```bash
# 方式1: Git回滚
git checkout HEAD -- src/webrtc.py src/basereal.py src/ttsreal.py
git rm src/audio_monitor.py

# 方式2: 禁用新功能
AUDIO_MONITOR=0 python main.py
# 并手动调整 webrtc.py 中的队列大小为100
```

## 后续优化建议

1. **自适应队列大小**: 根据网络状况动态调整队列容量
2. **更精细的时间同步**: 使用PID控制器平滑时间校准
3. **音频压缩**: 使用Opus等编码减少带宽占用
4. **网络丢包补偿**: 添加FEC(前向纠错)机制

## 参考资料

- WebRTC音频处理最佳实践
- asyncio队列设计模式
- 实时音频流同步算法

---
**修复日期**: 2025-11-24  
**修复人员**: AI Assistant  
**测试状态**: 待测试
